# 弹幕导入功能测试指南

## 🎯 修复内容

### 1. ✅ 每集独立存储弹幕

- **问题**: 之前可能所有集数共享弹幕
- **修复**: 使用 `danmaku:${source}:${videoId}:${episodeIndex}` 作为存储键
- **验证**: 导入第 1 集弹幕后，切换到第 2 集应该没有弹幕

### 2. ✅ 正确解析 Bilibili 颜色

- **问题**: 颜色全是深色
- **原因**: Bilibili 颜色值是十进制整数，需要转换
- **修复**:
  - `16777215` → `#FFFFFF` (白色)
  - `16711680` → `#FF0000` (红色)
  - `65280` → `#00FF00` (绿色)
- **验证**: 导入后查看控制台日志，会显示颜色分布统计

## 🧪 测试步骤

### 步骤 1: 清除旧数据（可选）

如果之前导入过错误的弹幕，建议先清除：

```bash
# 在 Upstash Redis 控制台执行
KEYS danmaku:*
# 然后逐个删除或使用 FLUSHDB（谨慎！）
```

### 步骤 2: 导入第 1 集弹幕

1. 打开任意长剧集（如《凡人修仙传》）
2. 播放第 1 集
3. 点击"导入弹幕"按钮
4. 在 Bilibili 找到对应第 1 集，获取 cid
5. 输入 cid，点击"开始导入"
6. **查看服务器控制台日志**：
   ```
   📦 获取到 Bilibili XML 响应，长度: xxxxx
   🎨 弹幕颜色分布: [['#FFFFFF', 1234], ['#FF0000', 56], ...]
   ✅ 解析出 xxxx 条弹幕
   📥 导入弹幕到: danmaku:lzi:397:0, 共 xxxx 条
   ✅ 成功导入弹幕到 danmaku:lzi:397:0
   ```

### 步骤 3: 验证弹幕显示

1. 刷新页面
2. 播放视频，应该能看到弹幕
3. **检查颜色**: 大部分弹幕应该是白色，少数红色/绿色等
4. **检查时间轴**: 弹幕应该在对应时间点出现

### 步骤 4: 切换到第 2 集

1. 点击切换到第 2 集
2. 此时**不应该有弹幕**（因为还没导入第 2 集）
3. 如果看到弹幕 = BUG（说明没有按集数隔离）

### 步骤 5: 导入第 2 集弹幕

1. 点击"导入弹幕"
2. 在 Bilibili 找到第 2 集的 cid
3. 导入后应该能看到第 2 集的弹幕
4. **查看控制台日志**，存储键应该是 `danmaku:lzi:397:1`（注意最后是 1）

## 🔍 调试信息

### 服务器控制台日志

导入时会输出：

- 📦 XML 响应长度
- 🎨 颜色分布（前 5 种最常见的颜色）
- ✅ 解析出的弹幕数量
- 📥 存储键和数量
- ✅ 导入成功确认

### 浏览器控制台

前端获取弹幕的 URL：

```
/api/danmaku?source=lzi&id=397&episode=0  ← 第1集
/api/danmaku?source=lzi&id=397&episode=1  ← 第2集
```

### Redis 键结构

```
danmaku:lzi:397:0  ← 第1集弹幕
danmaku:lzi:397:1  ← 第2集弹幕
danmaku:lzi:397:2  ← 第3集弹幕
...
```

## ✅ 预期结果

### 颜色分布示例

正常情况下，Bilibili 弹幕颜色分布应该类似：

```javascript
[
  ['#FFFFFF', 8523], // 白色 - 占大多数（80-90%）
  ['#FF0000', 452], // 红色
  ['#00FF00', 123], // 绿色
  ['#FFFF00', 89], // 黄色
  ['#FF00FF', 34], // 紫色
];
```

### 弹幕显示效果

- ✅ 大部分弹幕是白色
- ✅ 少数弹幕有其他颜色（红、绿、黄等）
- ✅ 每集弹幕独立，不会串到其他集
- ✅ 弹幕时间轴准确

## 🐛 常见问题

### 问题 1: 颜色还是不对

**排查**: 查看控制台日志中的颜色分布

- 如果全是 `#000000` 或深色 → colorInt 解析错误
- 如果全是 `#FFFFFF` → 可能 B 站返回的弹幕就是单色的

### 问题 2: 所有集数都显示相同弹幕

**排查**:

1. 查看浏览器 Network 标签，GET 请求的 URL
2. 确认 `episode` 参数是否随集数变化
3. 查看服务器日志，确认导入时的键是否包含正确的 episode

### 问题 3: 导入后没有弹幕

**排查**:

1. 查看服务器日志，确认是否成功解析和导入
2. 检查 Redis 中是否有数据（使用 Upstash 控制台）
3. 刷新页面重新加载弹幕

## 📝 测试清单

- [ ] 导入第 1 集弹幕成功
- [ ] 弹幕颜色正常（大部分白色）
- [ ] 切换到第 2 集，没有弹幕
- [ ] 导入第 2 集弹幕成功
- [ ] 第 2 集弹幕显示正常
- [ ] 切回第 1 集，弹幕依然存在
- [ ] 服务器日志显示正确的存储键
- [ ] 颜色分布统计合理

---

**提示**: 如果遇到问题，请提供服务器控制台的完整日志以便排查！
